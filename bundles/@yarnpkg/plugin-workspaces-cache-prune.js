/* eslint-disable */
//prettier-ignore
module.exports = {
name: "@yarnpkg/plugin-workspaces-cache-prune",
factory: function (require) {
var plugin=(()=>{var y=Object.defineProperty;var S=Object.getOwnPropertyDescriptor;var x=Object.getOwnPropertyNames;var H=Object.prototype.hasOwnProperty;var h=(t=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(t,{get:(s,n)=>(typeof require<"u"?require:s)[n]}):t)(function(t){if(typeof require<"u")return require.apply(this,arguments);throw new Error('Dynamic require of "'+t+'" is not supported')});var W=(t,s)=>{for(var n in s)y(t,n,{get:s[n],enumerable:!0})},I=(t,s,n,o)=>{if(s&&typeof s=="object"||typeof s=="function")for(let i of x(s))!H.call(t,i)&&i!==n&&y(t,i,{get:()=>s[i],enumerable:!(o=S(s,i))||o.enumerable});return t};var L=t=>I(y({},"__esModule",{value:!0}),t);var T={};W(T,{default:()=>R});var k=h("fs"),D=h("clipanion"),m=h("@yarnpkg/cli"),e=h("@yarnpkg/core"),w=class extends m.BaseCommand{constructor(){super(...arguments);this.workspaces=D.Option.Rest()}async execute(){let n=await e.Configuration.find(this.context.cwd,this.context.plugins),{project:o,workspace:i}=await e.Project.find(n,this.context.cwd),d;if(this.workspaces.length===0){if(!i)throw new m.WorkspaceRequiredError(o.cwd,this.context.cwd);d=new Set([i])}else d=new Set(this.workspaces.map(r=>o.getWorkspaceByIdent(e.structUtils.parseIdent(r))));for(let r of d)for(let c of e.Manifest.allDependencies)for(let f of r.manifest.getForScope(c).values()){let p=o.tryWorkspaceByDescriptor(f);p!==null&&d.add(p)}let u=await e.Cache.find(n),g=new Map;await o.resolveEverything({cache:u,report:new e.ThrowReport}),await o.fetchEverything({cache:u,report:new e.ThrowReport});let v=r=>{for(let c of r.values()){let f=o.storedResolutions.get(e.structUtils.isVirtualDescriptor(c)?e.structUtils.devirtualizeDescriptor(c).descriptorHash:c.descriptorHash),p=o.storedPackages.get(f),a=e.structUtils.slugifyLocator(p);g.has(a)||(g.set(a,!0),v(p.dependencies))}};for(let r of d){let c=r.manifest.dependencies;for(let[f,p]of c){let a;for(let l of o.storedPackages.values())l.identHash===f&&e.semverUtils.satisfiesWithPrereleases(l.version,p.range)&&(a=l);if(a){let l=e.structUtils.slugifyLocator(e.structUtils.isVirtualLocator(a)?e.structUtils.devirtualizeLocator(a):a);g.set(l,!0),v(a.dependencies)}}}let P=(0,k.readdirSync)(u.cwd);for(let r of P){let c=r.match(/(.*)-.+/);(!c||g.get(c[1])!==!0)&&(0,k.unlinkSync)(`${u.cwd}/${r}`)}console.log("Cache pruned for selected workspaces.")}};w.paths=[["workspaces-cache-prune"]];var M={commands:[w]},R=M;return L(T);})();
return plugin;
}
};
